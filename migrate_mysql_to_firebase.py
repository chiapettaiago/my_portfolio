#!/usr/bin/env python3
"""
Script de migra√ß√£o de MySQL para Firebase
Este script conecta ao banco MySQL existente e migra todos os dados para o Firebase Firestore.
"""

import os
import sys
import logging
from datetime import datetime
import pymysql
import firebase_admin
from firebase_admin import credentials, firestore

# Configura√ß√£o de logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('migration.log'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# Configura√ß√µes do MySQL
MYSQL_CONFIG = {
    'host': '144.22.178.234',
    'port': 3306,
    'user': 'portfolio',
    'password': '8MEPBTxaaZRaKxs8',
    'database': 'portfolio',
    'charset': 'utf8mb4'
}

# Configura√ß√£o do Firebase
FIREBASE_CREDENTIALS_PATH = 'firebase_credentials.json'

class MySQLToFirebaseMigrator:
    def __init__(self):
        self.mysql_conn = None
        self.firebase_db = None
        self.migration_stats = {
            'users': {'total': 0, 'migrated': 0, 'errors': 0},
            'posts': {'total': 0, 'migrated': 0, 'errors': 0},
            'comments': {'total': 0, 'migrated': 0, 'errors': 0},
            'pageviews': {'total': 0, 'migrated': 0, 'errors': 0},
            'powershell_scripts': {'total': 0, 'migrated': 0, 'errors': 0}
        }

    def connect_mysql(self):
        """Conecta ao banco MySQL"""
        try:
            self.mysql_conn = pymysql.connect(**MYSQL_CONFIG)
            logger.info("‚úÖ Conectado ao MySQL com sucesso!")
            return True
        except Exception as e:
            logger.error(f"‚ùå Erro ao conectar ao MySQL: {str(e)}")
            return False

    def connect_firebase(self):
        """Conecta ao Firebase"""
        try:
            if not os.path.exists(FIREBASE_CREDENTIALS_PATH):
                logger.error(f"‚ùå Arquivo de credenciais n√£o encontrado: {FIREBASE_CREDENTIALS_PATH}")
                return False
            
            cred = credentials.Certificate(FIREBASE_CREDENTIALS_PATH)
            firebase_admin.initialize_app(cred)
            self.firebase_db = firestore.client()
            logger.info("‚úÖ Conectado ao Firebase com sucesso!")
            return True
        except Exception as e:
            logger.error(f"‚ùå Erro ao conectar ao Firebase: {str(e)}")
            return False

    def get_mysql_tables(self):
        """Lista todas as tabelas do MySQL"""
        try:
            with self.mysql_conn.cursor() as cursor:
                cursor.execute("SHOW TABLES")
                tables = [row[0] for row in cursor.fetchall()]
                logger.info(f"üìã Tabelas encontradas no MySQL: {tables}")
                return tables
        except Exception as e:
            logger.error(f"‚ùå Erro ao listar tabelas: {str(e)}")
            return []    def migrate_users(self):
        """Migra usu√°rios do MySQL para Firebase"""
        logger.info("üë• Iniciando migra√ß√£o de usu√°rios...")
        
        try:
            with self.mysql_conn.cursor(pymysql.cursors.DictCursor) as cursor:
                # Verifica se a tabela user existe (sem 's')
                cursor.execute("SHOW TABLES LIKE 'user'")
                if not cursor.fetchone():
                    logger.warning("‚ö†Ô∏è Tabela 'user' n√£o encontrada no MySQL")
                    return
                
                # Busca todos os usu√°rios
                cursor.execute("SELECT * FROM user")
                users = cursor.fetchall()
                self.migration_stats['users']['total'] = len(users)
                
                logger.info(f"üìä Encontrados {len(users)} usu√°rios para migrar")
                
                # Migra cada usu√°rio
                for user in users:
                    try:
                        # Prepara os dados do usu√°rio para o Firestore
                        user_data = {
                            'username': user.get('username', ''),
                            'password': user.get('password', ''),
                            'fullname': user.get('fullname', ''),
                            'email': user.get('email', ''),
                            'phone': user.get('phone', ''),
                            'role': user.get('role', 'user'),
                            'mysql_id': user.get('id'),  # Preserva o ID original para refer√™ncias
                            'created_at': datetime.now(),
                            'updated_at': datetime.now()
                        }
                        
                        # Salva no Firebase
                        doc_ref = self.firebase_db.collection('users').document()
                        doc_ref.set(user_data)
                        
                        self.migration_stats['users']['migrated'] += 1
                        logger.info(f"‚úÖ Usu√°rio migrado: {user.get('username', 'N/A')}")
                        
                    except Exception as e:
                        self.migration_stats['users']['errors'] += 1
                        logger.error(f"‚ùå Erro ao migrar usu√°rio {user.get('username', 'N/A')}: {str(e)}")
                        
        except Exception as e:
            logger.error(f"‚ùå Erro na migra√ß√£o de usu√°rios: {str(e)}")    def migrate_posts(self):
        """Migra posts do MySQL para Firebase"""
        logger.info("üìù Iniciando migra√ß√£o de posts...")
        
        try:
            with self.mysql_conn.cursor(pymysql.cursors.DictCursor) as cursor:
                # Verifica se a tabela post existe (sem 's')
                cursor.execute("SHOW TABLES LIKE 'post'")
                if not cursor.fetchone():
                    logger.warning("‚ö†Ô∏è Tabela 'post' n√£o encontrada no MySQL")
                    return
                
                # Busca todos os posts
                cursor.execute("SELECT * FROM post")
                posts = cursor.fetchall()
                self.migration_stats['posts']['total'] = len(posts)
                
                logger.info(f"üìä Encontrados {len(posts)} posts para migrar")
                
                # Migra cada post
                for post in posts:
                    try:
                        # Prepara os dados do post para o Firestore
                        post_data = {
                            'title': post.get('title', ''),
                            'slug': post.get('slug', ''),
                            'content': post.get('content', ''),
                            'created_at': post.get('created_at', datetime.now()),
                            'scheduled_for': post.get('scheduled_for'),
                            'is_published': bool(post.get('is_published', False)),
                            'main_image': post.get('main_image'),
                            'user_id': str(post.get('user_id', '')),
                            'mysql_id': post.get('id'),  # Preserva o ID original
                            'updated_at': datetime.now()
                        }
                        
                        # Salva no Firebase
                        doc_ref = self.firebase_db.collection('posts').document()
                        doc_ref.set(post_data)
                        
                        self.migration_stats['posts']['migrated'] += 1
                        logger.info(f"‚úÖ Post migrado: {post.get('title', 'N/A')}")
                        
                    except Exception as e:
                        self.migration_stats['posts']['errors'] += 1
                        logger.error(f"‚ùå Erro ao migrar post {post.get('title', 'N/A')}: {str(e)}")
                        
        except Exception as e:
            logger.error(f"‚ùå Erro na migra√ß√£o de posts: {str(e)}")    def migrate_comments(self):
        """Migra coment√°rios do MySQL para Firebase"""
        logger.info("üí¨ Iniciando migra√ß√£o de coment√°rios...")
        
        try:
            with self.mysql_conn.cursor(pymysql.cursors.DictCursor) as cursor:
                # Verifica se a tabela comment existe (sem 's')
                cursor.execute("SHOW TABLES LIKE 'comment'")
                if not cursor.fetchone():
                    logger.warning("‚ö†Ô∏è Tabela 'comment' n√£o encontrada no MySQL")
                    return
                
                # Busca todos os coment√°rios
                cursor.execute("SELECT * FROM comment")
                comments = cursor.fetchall()
                self.migration_stats['comments']['total'] = len(comments)
                
                logger.info(f"üìä Encontrados {len(comments)} coment√°rios para migrar")
                
                # Migra cada coment√°rio
                for comment in comments:
                    try:
                        # Prepara os dados do coment√°rio para o Firestore
                        comment_data = {
                            'post_id': str(comment.get('post_id', '')),
                            'user_id': str(comment.get('user_id', '')),
                            'content': comment.get('content', ''),
                            'created_at': comment.get('created_at', datetime.now()),
                            'mysql_id': comment.get('id'),  # Preserva o ID original
                            'updated_at': datetime.now()
                        }
                        
                        # Salva no Firebase
                        doc_ref = self.firebase_db.collection('comments').document()
                        doc_ref.set(comment_data)
                        
                        self.migration_stats['comments']['migrated'] += 1
                        logger.info(f"‚úÖ Coment√°rio migrado: ID {comment.get('id', 'N/A')}")
                        
                    except Exception as e:
                        self.migration_stats['comments']['errors'] += 1
                        logger.error(f"‚ùå Erro ao migrar coment√°rio {comment.get('id', 'N/A')}: {str(e)}")
                        
        except Exception as e:
            logger.error(f"‚ùå Erro na migra√ß√£o de coment√°rios: {str(e)}")    def migrate_pageviews(self):
        """Migra visualiza√ß√µes de p√°gina do MySQL para Firebase"""
        logger.info("üëÄ Iniciando migra√ß√£o de page views...")
        
        try:
            with self.mysql_conn.cursor(pymysql.cursors.DictCursor) as cursor:
                # Verifica se a tabela page_view existe
                cursor.execute("SHOW TABLES LIKE 'page_view'")
                if not cursor.fetchone():
                    logger.warning("‚ö†Ô∏è Tabela 'page_view' n√£o encontrada no MySQL")
                    return
                
                # Busca todas as visualiza√ß√µes (limitando para evitar sobrecarga)
                cursor.execute("SELECT * FROM page_view ORDER BY timestamp DESC LIMIT 10000")
                pageviews = cursor.fetchall()
                self.migration_stats['pageviews']['total'] = len(pageviews)
                
                logger.info(f"üìä Encontradas {len(pageviews)} visualiza√ß√µes para migrar")
                
                # Migra cada visualiza√ß√£o
                for pageview in pageviews:
                    try:
                        # Prepara os dados da visualiza√ß√£o para o Firestore
                        pageview_data = {
                            'path': pageview.get('path', ''),
                            'ip': pageview.get('ip', ''),
                            'user_agent': pageview.get('user_agent', ''),
                            'browser': pageview.get('browser', ''),
                            'device_type': pageview.get('device_type', ''),
                            'referrer': pageview.get('referrer'),
                            'timestamp': pageview.get('timestamp', datetime.now()),
                            'user_id': str(pageview.get('user_id', '')) if pageview.get('user_id') else None,
                            'mysql_id': pageview.get('id')  # Preserva o ID original
                        }
                        
                        # Salva no Firebase
                        doc_ref = self.firebase_db.collection('pageviews').document()
                        doc_ref.set(pageview_data)
                        
                        self.migration_stats['pageviews']['migrated'] += 1
                        
                        # Log a cada 100 registros para n√£o sobrecarregar
                        if self.migration_stats['pageviews']['migrated'] % 100 == 0:
                            logger.info(f"‚úÖ {self.migration_stats['pageviews']['migrated']} visualiza√ß√µes migradas...")
                        
                    except Exception as e:
                        self.migration_stats['pageviews']['errors'] += 1
                        logger.error(f"‚ùå Erro ao migrar pageview {pageview.get('id', 'N/A')}: {str(e)}")
                        
        except Exception as e:
            logger.error(f"‚ùå Erro na migra√ß√£o de pageviews: {str(e)}")    def migrate_powershell_scripts(self):
        """Migra scripts PowerShell do MySQL para Firebase"""
        logger.info("‚ö° Iniciando migra√ß√£o de scripts PowerShell...")
        
        try:
            with self.mysql_conn.cursor(pymysql.cursors.DictCursor) as cursor:
                # Verifica se a tabela power_shell_script existe
                cursor.execute("SHOW TABLES LIKE 'power_shell_script'")
                if not cursor.fetchone():
                    logger.warning("‚ö†Ô∏è Tabela 'power_shell_script' n√£o encontrada no MySQL")
                    return
                
                # Busca todos os scripts
                cursor.execute("SELECT * FROM power_shell_script")
                scripts = cursor.fetchall()
                self.migration_stats['powershell_scripts']['total'] = len(scripts)
                
                logger.info(f"üìä Encontrados {len(scripts)} scripts PowerShell para migrar")
                
                # Migra cada script
                for script in scripts:
                    try:
                        # Prepara os dados do script para o Firestore
                        script_data = {
                            'token': script.get('token', ''),
                            'script': script.get('script', ''),
                            'description': script.get('description', ''),
                            'created_at': script.get('created_at', datetime.now()),
                            'expires_at': script.get('expires_at'),
                            'created_by': str(script.get('created_by', '')),
                            'access_count': int(script.get('access_count', 0)),
                            'last_accessed': script.get('last_accessed'),
                            'mysql_id': script.get('id'),  # Preserva o ID original
                            'updated_at': datetime.now()
                        }
                        
                        # Salva no Firebase
                        doc_ref = self.firebase_db.collection('powershellscripts').document()
                        doc_ref.set(script_data)
                        
                        self.migration_stats['powershell_scripts']['migrated'] += 1
                        logger.info(f"‚úÖ Script PowerShell migrado: {script.get('description', 'N/A')}")
                        
                    except Exception as e:
                        self.migration_stats['powershell_scripts']['errors'] += 1
                        logger.error(f"‚ùå Erro ao migrar script {script.get('token', 'N/A')}: {str(e)}")
                        
        except Exception as e:
            logger.error(f"‚ùå Erro na migra√ß√£o de scripts PowerShell: {str(e)}")

    def print_migration_summary(self):
        """Exibe um resumo da migra√ß√£o"""
        logger.info("\n" + "="*60)
        logger.info("üìä RESUMO DA MIGRA√á√ÉO")
        logger.info("="*60)
        
        total_records = 0
        total_migrated = 0
        total_errors = 0
        
        for table, stats in self.migration_stats.items():
            logger.info(f"üìã {table.upper()}:")
            logger.info(f"   Total: {stats['total']}")
            logger.info(f"   Migrados: {stats['migrated']}")
            logger.info(f"   Erros: {stats['errors']}")
            logger.info(f"   Taxa de sucesso: {(stats['migrated']/stats['total']*100) if stats['total'] > 0 else 0:.1f}%")
            logger.info("")
            
            total_records += stats['total']
            total_migrated += stats['migrated']
            total_errors += stats['errors']
        
        logger.info(f"üî¢ TOTAIS GERAIS:")
        logger.info(f"   Total de registros: {total_records}")
        logger.info(f"   Migrados com sucesso: {total_migrated}")
        logger.info(f"   Erros: {total_errors}")
        logger.info(f"   Taxa de sucesso geral: {(total_migrated/total_records*100) if total_records > 0 else 0:.1f}%")
        logger.info("="*60)

    def run_migration(self):
        """Executa a migra√ß√£o completa"""
        logger.info("üöÄ Iniciando migra√ß√£o de MySQL para Firebase...")
        
        # Conecta aos bancos
        if not self.connect_mysql():
            return False
        
        if not self.connect_firebase():
            return False
        
        # Lista as tabelas dispon√≠veis
        tables = self.get_mysql_tables()
        
        # Executa as migra√ß√µes
        self.migrate_users()
        self.migrate_posts()
        self.migrate_comments()
        self.migrate_pageviews()
        self.migrate_powershell_scripts()
        
        # Exibe o resumo
        self.print_migration_summary()
        
        # Fecha conex√µes
        if self.mysql_conn:
            self.mysql_conn.close()
            logger.info("üîê Conex√£o MySQL fechada")
        
        logger.info("‚úÖ Migra√ß√£o conclu√≠da!")
        return True

def main():
    """Fun√ß√£o principal"""
    print("üîÑ Script de Migra√ß√£o MySQL ‚Üí Firebase")
    print("=" * 50)
    
    # Verifica se o arquivo de credenciais existe
    if not os.path.exists(FIREBASE_CREDENTIALS_PATH):
        print(f"‚ùå Arquivo de credenciais n√£o encontrado: {FIREBASE_CREDENTIALS_PATH}")
        print("Por favor, configure suas credenciais do Firebase antes de continuar.")
        return
    
    # Pergunta se o usu√°rio quer continuar
    response = input("‚ö†Ô∏è  Esta opera√ß√£o ir√° migrar dados do MySQL para o Firebase. Continuar? (s/N): ")
    if response.lower() not in ['s', 'sim', 'y', 'yes']:
        print("‚ùå Migra√ß√£o cancelada pelo usu√°rio.")
        return
    
    # Executa a migra√ß√£o
    migrator = MySQLToFirebaseMigrator()
    success = migrator.run_migration()
    
    if success:
        print("\nüéâ Migra√ß√£o conclu√≠da com sucesso!")
        print("üìÑ Verifique o arquivo 'migration.log' para detalhes completos.")
    else:
        print("\n‚ùå Migra√ß√£o falhou. Verifique os logs para mais detalhes.")

if __name__ == "__main__":
    main()
